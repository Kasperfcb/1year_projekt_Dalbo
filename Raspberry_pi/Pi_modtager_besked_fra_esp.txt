import socket
import sqlite3

server_ip = "192.168.43.134"  # Lyt på alle netværksinterfaces
server_port = 8002

# Databaseoplysninger
dbname = "års-pro.db"

def start_server():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind((server_ip, server_port))
    server.listen(1)
    print('Server started. Waiting for connections...')

    while True:
        client, addr = server.accept()
        print('New connection from:', addr[0])
        handle_connection(client)

def handle_connection(client):
    while True:
        data = client.recv(1024)
        if data:
            message = data.decode().strip()
            print('Received data:', message)
            
            # Gem data i databasen
            try:
                conn = sqlite3.connect(dbname)
                cursor = conn.cursor()
                sql = "INSERT INTO modtaget_data (timestamp) VALUES (?)"
                cursor.execute(sql, (message,))
                conn.commit()
                print('Data blev indsat i databasen.')
            except sqlite3.Error as e:
                print('Fejl ved indsættelse af data:', str(e))
            finally:
                cursor.close()
                conn.close()

            # Eksempel: Send bekræftelsesbesked tilbage til ESP32-serveren
            #response = "Bekræftelse: Besked modtaget"
            #client.sendall(response.encode())
        else:
            break

    client.close()
    print('...')

# Start serveren
start_server()
